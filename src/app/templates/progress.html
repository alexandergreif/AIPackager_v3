{% extends "base.html" %}

{% block title %}Generating Script...{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-lg shadow-md">

    <h2 class="text-2xl font-bold mb-6">Processing Progress</h2>

    <div class="mb-4">
        <div id="stages" class="flex justify-between">
            <div class="stage" id="stage-1">1. Instruction Processing</div>
            <div class="stage" id="stage-2">2. Targeted RAG</div>
            <div class="stage" id="stage-3">3. Script Generation</div>
            <div class="stage" id="stage-4">4. Hallucination Detection</div>
            <div class="stage" id="stage-5">5. Advisor Correction</div>
        </div>
    </div>

    <div class="w-full bg-gray-200 rounded-full">
        <div id="progress-bar" class="bg-blue-500 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full" style="width: 0%">0%</div>
    </div>
    <p id="progress-message" class="mt-4 text-gray-600">Preparing...</p>
    <p id="error-message" class="mt-2 text-red-600"></p>
</div>

<style>
    .stage {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        border-bottom: 2px solid #e5e7eb; /* gray-200 */
        color: #6b7280; /* gray-500 */
    }
    .stage.active {
        border-bottom-color: #3b82f6; /* blue-500 */
        font-weight: bold;
        color: #1f2937; /* gray-800 */
    }
</style>

<script>
const jobId = "{{ job_id }}";
const eventSource = new EventSource(`/stream-progress/${jobId}`);

eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const bar = document.getElementById('progress-bar');
    const message = document.getElementById('progress-message');
    bar.style.width = `${data.progress}%`;
    bar.textContent = `${data.progress}%`;
    message.textContent = data.current_step;

    // Update stage indicator
    const stages = document.querySelectorAll('.stage');
    stages.forEach(stage => stage.classList.remove('active'));
    if (data.stage_number) {
        const activeStage = document.getElementById(`stage-${data.stage_number}`);
        if (activeStage) {
            activeStage.classList.add('active');
        }
    }

    if (data.status === 'completed') {
        eventSource.close();
        window.location.href = `/detail/${jobId}`;
    } else if (data.status === 'failed') {
        eventSource.close();
        document.getElementById('error-message').textContent = 'Script generation failed. Please try again.';
    }
};

eventSource.onerror = function(err) {
    console.error("EventSource failed:", err);
    eventSource.close();
};
</script>
{% endblock %}
